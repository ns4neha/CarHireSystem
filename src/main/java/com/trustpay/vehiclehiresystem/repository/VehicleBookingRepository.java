package com.trustpay.vehiclehiresystem.repository;

import com.trustpay.vehiclehiresystem.model.Customer;
import com.trustpay.vehiclehiresystem.model.Vehicle;
import org.springframework.stereotype.Repository;
import org.springframework.util.Assert;

import java.text.MessageFormat;
import java.util.*;
import java.util.stream.Collectors;

@Repository
public class VehicleBookingRepository {

    Map<Integer, Vehicle> vehicleMap = Collections.synchronizedMap(new HashMap<Integer,Vehicle>());
    Map<Customer, List<Vehicle>> customerVehicleBooking = Collections.synchronizedMap(new HashMap<Customer, List<Vehicle>>());
    Random random = new Random();

    private int nextNonNegative() {
        return random.nextInt(Integer.SIZE - 1);
    }

    public Integer save(Vehicle vehicle) {

        Assert.isNull(vehicle.getId(), "Id is to be generated by the add method.");
        vehicle.setId(nextNonNegative());
        vehicleMap.put(vehicle.getId(), vehicle);

        return vehicle.getId();
    }

    public List<Vehicle> findAll() {

        return new ArrayList<>(vehicleMap.values());
    }

    public List<Vehicle> findByBookedTrue() {

        return vehicleMap.values().stream().filter(v -> v.isBooked()).collect(Collectors.toList());
    }

    public List<Vehicle> findByBookedFalse() {

        return vehicleMap.values().stream().filter(v -> !v.isBooked()).collect(Collectors.toList());
    }

    public boolean allocateVehiclesToCustomer(List<Integer> vehicleIdList, Customer customer) {
        Optional<Integer> isVehicleAlreadyBooked = vehicleIdList.stream().filter(id -> vehicleMap.get(id).isBooked()).findAny();

        isVehicleAlreadyBooked.ifPresent((vehicleId) -> {throw new UnsupportedOperationException(
                MessageFormat.format("%s vehicle is already booked. Cannot allocate this now to a new customer", vehicleId));});

        synchronized (vehicleMap) {
            vehicleIdList.stream().forEach(vehicleId -> {
                Vehicle vehicle = vehicleMap.get(vehicleId);

                synchronized (vehicle) {
                    vehicle.setBooked(true);
                    customerVehicleBooking.putIfAbsent(customer, Collections.synchronizedList(new ArrayList<>()));
                    List<Vehicle> vehicleList = customerVehicleBooking.get(customer);
                    vehicleList.add(vehicle);
                }
            });

        }
        return true;
    }

}